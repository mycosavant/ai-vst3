name: Build VST3 & AU - All Platforms

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1

      - name: Configure CMake
        working-directory: vst
        run: cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release

      - name: Build
        working-directory: vst
        run: cmake --build build --config Release

      - name: Upload Windows VST3
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-Windows-VST3
          path: vst/build/ObsidianNeuralVST_artefacts/Release/VST3/

  build-macos-universal:
    name: Build macOS Universal (VST3 + AU)
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: brew install cmake ninja

      - name: Configure CMake
        working-directory: vst
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="10.15"

      - name: Build
        working-directory: vst
        run: cmake --build build --config Release

      - name: Verify build
        run: |
          echo "=== VST3 Build ==="
          lipo -info vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3/Contents/MacOS/OBSIDIAN-Neural

          echo ""
          echo "=== AU Build ==="
          lipo -info vst/build/ObsidianNeuralVST_artefacts/Release/AU/OBSIDIAN-Neural.component/Contents/MacOS/OBSIDIAN-Neural

      - name: Fix macOS permissions
        run: |
          chmod +x vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3/Contents/MacOS/*
          chmod +x vst/build/ObsidianNeuralVST_artefacts/Release/AU/OBSIDIAN-Neural.component/Contents/MacOS/*

      - name: Import Code Signing Certificate
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          echo $MACOS_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security import certificate.p12 -k build.keychain -P $MACOS_CERTIFICATE_PWD -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k actions build.keychain
          rm certificate.p12

      - name: Sign VST3 & AU
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Sign VST3
          codesign --force --sign "Developer ID Application: anthony charretier ($APPLE_TEAM_ID)" \
            --timestamp --options runtime --deep \
            vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3

          # Sign AU
          codesign --force --sign "Developer ID Application: anthony charretier ($APPLE_TEAM_ID)" \
            --timestamp --options runtime --deep \
            vst/build/ObsidianNeuralVST_artefacts/Release/AU/OBSIDIAN-Neural.component

      - name: Verify signatures
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "=== VST3 Signature ==="
          codesign --verify --verbose vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3

          echo ""
          echo "=== AU Signature ==="
          codesign --verify --verbose vst/build/ObsidianNeuralVST_artefacts/Release/AU/OBSIDIAN-Neural.component

      - name: Create ZIPs for notarization
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cd vst/build/ObsidianNeuralVST_artefacts/Release

          # VST3
          cd VST3
          ditto -c -k --keepParent OBSIDIAN-Neural.vst3 OBSIDIAN-Neural-VST3.zip
          mv OBSIDIAN-Neural-VST3.zip ../../../../../../
          cd ..

          # AU
          cd AU
          ditto -c -k --keepParent OBSIDIAN-Neural.component OBSIDIAN-Neural-AU.zip
          mv OBSIDIAN-Neural-AU.zip ../../../../../../

      - name: Notarize VST3
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool submit OBSIDIAN-Neural-VST3.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

      - name: Notarize AU
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool submit OBSIDIAN-Neural-AU.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

      - name: Staple VST3 & AU
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          xcrun stapler staple vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3
          xcrun stapler staple vst/build/ObsidianNeuralVST_artefacts/Release/AU/OBSIDIAN-Neural.component

      - name: Upload macOS VST3
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-macOS-Universal-VST3
          path: vst/build/ObsidianNeuralVST_artefacts/Release/VST3/

      - name: Upload macOS AU
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-macOS-Universal-AU
          path: vst/build/ObsidianNeuralVST_artefacts/Release/AU/

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build \
            libasound2-dev libx11-dev libxext-dev libxrandr-dev libxcomposite-dev \
            libxinerama-dev libxcursor-dev libfreetype6-dev libfontconfig1-dev \
            libgtk-3-dev libwebkit2gtk-4.1-dev libcurl4-openssl-dev

      - name: Configure CMake
        working-directory: vst
        run: cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        working-directory: vst
        run: cmake --build build --config Release

      - name: Upload Linux VST3
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-Linux-VST3
          path: vst/build/ObsidianNeuralVST_artefacts/Release/VST3/

  create-release:
    needs: [build-windows, build-macos-universal, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release assets
        run: |
          # Windows VST3
          if [ -d "ObsidianNeural-Windows-VST3" ]; then
            cd ObsidianNeural-Windows-VST3
            zip -r ../OBSIDIAN-Neural-Windows-VST3.zip .
            cd ..
          fi

          # macOS VST3
          if [ -d "ObsidianNeural-macOS-Universal-VST3" ]; then
            cd ObsidianNeural-macOS-Universal-VST3
            zip -r ../OBSIDIAN-Neural-macOS-VST3.zip .
            cd ..
          fi

          # macOS AU
          if [ -d "ObsidianNeural-macOS-Universal-AU" ]; then
            cd ObsidianNeural-macOS-Universal-AU
            zip -r ../OBSIDIAN-Neural-macOS-AU.zip .
            cd ..
          fi

          # Linux VST3
          if [ -d "ObsidianNeural-Linux-VST3" ]; then
            cd ObsidianNeural-Linux-VST3
            tar -czf ../OBSIDIAN-Neural-Linux-VST3.tar.gz .
            cd ..
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: "OBSIDIAN-Neural v${{ github.run_number }}"
          body: |
            # üéµ OBSIDIAN-Neural Release v${{ github.run_number }}

            ## üì• Installation

            ### üéØ **Cloud API** (Recommended - No GPU Required)

            #### **Windows**
            1. Download `OBSIDIAN-Neural-Windows-VST3.zip`
            2. Extract to `C:\Program Files\Common Files\VST3\`
            3. Get your API key at [obsidian-neural.com](https://obsidian-neural.com)
            4. Load in your DAW

            #### **macOS** (10.15 Catalina ‚Üí 15.0 Sequoia)

            **For Ableton, Bitwig, FL Studio, Reaper:**
            1. Download `OBSIDIAN-Neural-macOS-VST3.zip`
            2. Extract and double-click `OBSIDIAN-Neural.vst3` to install
            3. Or manually copy to `~/Library/Audio/Plug-Ins/VST3/`

            **For Logic Pro, GarageBand:**
            1. Download `OBSIDIAN-Neural-macOS-AU.zip`
            2. Extract and double-click `OBSIDIAN-Neural.component` to install
            3. Or manually copy to `~/Library/Audio/Plug-Ins/Components/`

            üí° **Logic Pro users: Use the AU version for best compatibility**

            Get your API key at [obsidian-neural.com](https://obsidian-neural.com)

            #### **Linux**
            1. Download `OBSIDIAN-Neural-Linux-VST3.tar.gz`
            2. Extract to `~/.vst3/`
            3. Get your API key at [obsidian-neural.com](https://obsidian-neural.com)
            4. Load in your DAW

            ---

            ### üîß **Self-Hosted Server** (Advanced)

            **Requirements:** NVIDIA GPU with CUDA, Python 3.10+
            ```bash
            # Clone the repository
            git clone https://github.com/innermost47/ai-dj.git
            cd ai-dj

            # Run the installer
            python installer.py
            ```

            The installer will guide you through the setup process and start the local server.

            ---

            ## üìö Resources

            - üìò [Getting Started](https://obsidian-neural.com/documentation.html?page=getting-started)
            - üöÄ [First Steps](https://obsidian-neural.com/documentation.html?page=first-step)
            - üéµ [Bank Management](https://obsidian-neural.com/documentation.html?page=bank-management)
            - üé® [Draw to Audio](https://obsidian-neural.com/documentation.html?page=draw-to-audio)
            - üéì [Video Tutorial](https://www.youtube.com/watch?v=l4KMC5adxVA)
            - üí¨ [Discussions](https://github.com/innermost47/ai-dj/discussions)
            - üêõ [Issues](https://github.com/innermost47/ai-dj/issues)

            ---

            ‚≠ê Star the repo if you find OBSIDIAN-Neural useful!

          files: |
            OBSIDIAN-Neural-Windows-VST3.zip
            OBSIDIAN-Neural-macOS-VST3.zip
            OBSIDIAN-Neural-macOS-AU.zip
            OBSIDIAN-Neural-Linux-VST3.tar.gz
