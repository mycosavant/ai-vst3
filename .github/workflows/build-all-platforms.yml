name: Build VST - All Platforms

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1

      - name: Configure CMake
        working-directory: vst
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release

      - name: Build
        working-directory: vst
        run: |
          cmake --build build --config Release

      - name: Upload Windows VST
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-Windows-VST3
          path: vst/build/ObsidianNeuralVST_artefacts/Release/VST3/

  build-macos:
    runs-on: macos-latest # C'est dÃ©jÃ  bon, c'est arm64

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install cmake ninja create-dmg

      - name: Configure CMake
        working-directory: vst
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"

      - name: Build
        working-directory: vst
        run: |
          cmake --build build --config Release

      - name: Fix macOS permissions
        run: |
          chmod +x vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3/Contents/MacOS/*

      - name: Upload macOS VST
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-macOS-VST3
          path: vst/build/ObsidianNeuralVST_artefacts/Release/VST3/

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            libasound2-dev \
            libx11-dev libxext-dev libxrandr-dev libxcomposite-dev \
            libxinerama-dev libxcursor-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libcurl4-openssl-dev

      - name: Configure CMake
        working-directory: vst
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        working-directory: vst
        run: |
          cmake --build build --config Release

      - name: Upload Linux VST
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-Linux-VST3
          path: vst/build/ObsidianNeuralVST_artefacts/Release/VST3/

  build-python-executables:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux

          - os: macos-15-intel # Nouveau runner Intel
            name: macos-intel

          - os: macos-latest # Apple Silicon (arm64)
            name: macos-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          pip install pillow pyinstaller psutil pystray GPUtil

      - name: Build executables
        shell: bash
        run: |
          pyinstaller --onefile --hidden-import=psutil --hidden-import=pystray --hidden-import=GPUtil --name obsidian-server-${{ matrix.name }} server_interface.py
          pyinstaller --onefile --hidden-import=psutil --hidden-import=pystray --hidden-import=GPUtil --name obsidian-installer-${{ matrix.name }} installer.py

      - name: Upload Python executables
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-Python-${{ matrix.name }}
          path: dist/

  build-macos-packages:
    needs: [build-python-executables]
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Download macOS Python executables
        uses: actions/download-artifact@v4
        with:
          name: ObsidianNeural-Python-macos-intel
          path: ./python-tools-intel/

      - name: Download macOS ARM Python executables
        uses: actions/download-artifact@v4
        with:
          name: ObsidianNeural-Python-macos-arm64
          path: ./python-tools-arm64/

      - name: Create Intel DMG with installer
        run: |
          mkdir -p dmg-staging-intel

          # Copy Intel installer
          cp python-tools-intel/obsidian-installer-macos-intel dmg-staging-intel/OBSIDIAN-Neural-Installer
          chmod +x dmg-staging-intel/OBSIDIAN-Neural-Installer

      - name: Create ARM DMG with installer
        run: |
          mkdir -p dmg-staging-arm64

          # Copy ARM installer
          cp python-tools-arm64/obsidian-installer-macos-arm64 dmg-staging-arm64/OBSIDIAN-Neural-Installer
          chmod +x dmg-staging-arm64/OBSIDIAN-Neural-Installer

      - name: Create Intel DMG
        run: |
          create-dmg \
            --volname "OBSIDIAN-Neural-Installer-Intel" \
            --window-pos 200 120 \
            --window-size 500 300 \
            --icon-size 100 \
            --icon "OBSIDIAN-Neural-Installer" 250 150 \
            --hide-extension "OBSIDIAN-Neural-Installer" \
            "OBSIDIAN-Neural-Installer-macOS-Intel.dmg" \
            "dmg-staging-intel/"

      - name: Create ARM DMG
        run: |
          create-dmg \
            --volname "OBSIDIAN-Neural-Installer-ARM64" \
            --window-pos 200 120 \
            --window-size 500 300 \
            --icon-size 100 \
            --icon "OBSIDIAN-Neural-Installer" 250 150 \
            --hide-extension "OBSIDIAN-Neural-Installer" \
            "OBSIDIAN-Neural-Installer-macOS-ARM64.dmg" \
            "dmg-staging-arm64/"

      - name: Upload Intel DMG
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-macOS-DMG-Intel
          path: OBSIDIAN-Neural-Installer-macOS-Intel.dmg

      - name: Upload ARM DMG
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-macOS-DMG-ARM64
          path: OBSIDIAN-Neural-Installer-macOS-ARM64.dmg

      - name: Prepare Intel PKG payload
        run: |
          mkdir -p pkg-staging-intel/payload/usr/local/bin
          mkdir -p pkg-staging-intel/scripts

          # Copy Intel installer to payload
          cp python-tools-intel/obsidian-installer-macos-intel pkg-staging-intel/payload/usr/local/bin/obsidian-installer
          chmod +x pkg-staging-intel/payload/usr/local/bin/obsidian-installer

          # Copy Intel server to payload
          cp python-tools-intel/obsidian-server-macos-intel pkg-staging-intel/payload/usr/local/bin/obsidian-server
          chmod +x pkg-staging-intel/payload/usr/local/bin/obsidian-server

      - name: Prepare ARM PKG payload
        run: |
          mkdir -p pkg-staging-arm64/payload/usr/local/bin
          mkdir -p pkg-staging-arm64/scripts

          # Copy ARM installer to payload
          cp python-tools-arm64/obsidian-installer-macos-arm64 pkg-staging-arm64/payload/usr/local/bin/obsidian-installer
          chmod +x pkg-staging-arm64/payload/usr/local/bin/obsidian-installer

          # Copy ARM server to payload
          cp python-tools-arm64/obsidian-server-macos-arm64 pkg-staging-arm64/payload/usr/local/bin/obsidian-server
          chmod +x pkg-staging-arm64/payload/usr/local/bin/obsidian-server

      - name: Create Intel postinstall script
        run: |
          cat > pkg-staging-intel/scripts/postinstall << 'EOF'
          #!/bin/bash
          ln -sf /usr/local/bin/obsidian-installer /usr/local/bin/obsidian-neural
          echo "OBSIDIAN-Neural (Intel) installed successfully!"
          echo "Available commands:"
          echo "  obsidian-neural    - Run installer"
          echo "  obsidian-server    - Run server directly"
          echo "  obsidian-installer - Run installer directly"
          exit 0
          EOF
          chmod +x pkg-staging-intel/scripts/postinstall

      - name: Create ARM postinstall script
        run: |
          cat > pkg-staging-arm64/scripts/postinstall << 'EOF'
          #!/bin/bash
          ln -sf /usr/local/bin/obsidian-installer /usr/local/bin/obsidian-neural
          echo "OBSIDIAN-Neural (Apple Silicon) installed successfully!"
          echo "Available commands:"
          echo "  obsidian-neural    - Run installer"
          echo "  obsidian-server    - Run server directly"
          echo "  obsidian-installer - Run installer directly"
          exit 0
          EOF
          chmod +x pkg-staging-arm64/scripts/postinstall

      - name: Build Intel PKG
        run: |
          pkgbuild \
            --root pkg-staging-intel/payload \
            --identifier com.obsidianneural.installer.intel \
            --version "1.0.${{ github.run_number }}" \
            --scripts pkg-staging-intel/scripts \
            --install-location / \
            OBSIDIAN-Neural-Installer-macOS-Intel.pkg

      - name: Build ARM PKG
        run: |
          pkgbuild \
            --root pkg-staging-arm64/payload \
            --identifier com.obsidianneural.installer.arm64 \
            --version "1.0.${{ github.run_number }}" \
            --scripts pkg-staging-arm64/scripts \
            --install-location / \
            OBSIDIAN-Neural-Installer-macOS-ARM64.pkg

      - name: Upload Intel PKG
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-macOS-PKG-Intel
          path: OBSIDIAN-Neural-Installer-macOS-Intel.pkg

      - name: Upload ARM PKG
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-macOS-PKG-ARM64
          path: OBSIDIAN-Neural-Installer-macOS-ARM64.pkg

  commit-binaries:
    needs: [build-python-executables]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    concurrency:
      group: commit-binaries
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ObsidianNeural-Python-*
          merge-multiple: false

      - name: Organize binaries
        run: |
          rm -rf bin/*
          mkdir -p bin

          if [ -d "ObsidianNeural-Python-macos-intel" ]; then
            cp ObsidianNeural-Python-macos-intel/obsidian-server-macos-intel bin/OBSIDIAN-Neural-Server-macos-intel
          fi

          if [ -d "ObsidianNeural-Python-macos-arm64" ]; then
            cp ObsidianNeural-Python-macos-arm64/obsidian-server-macos-arm64 bin/OBSIDIAN-Neural-Server-macos-arm64
          fi

          if [ -d "ObsidianNeural-Python-linux" ]; then
            cp ObsidianNeural-Python-linux/obsidian-server-linux bin/OBSIDIAN-Neural-Server-linux
          fi

      - name: Commit binaries
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add bin/
          git commit -m "Update binaries [skip ci]" || exit 0

          git pull --rebase origin main
          git push

  create-release:
    needs:
      [
        build-windows,
        build-macos,
        build-linux,
        build-python-executables,
        build-macos-packages,
        commit-binaries,
      ]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release assets
        run: |
          # Copy installer.py for Windows users
          cp installer.py ./OBSIDIAN-Neural-Installer.py

          # VST3 plugins
          if [ -d "ObsidianNeural-Windows-VST3" ]; then
            cd ObsidianNeural-Windows-VST3
            zip -r ../OBSIDIAN-Neural-Windows-VST3.zip .
            cd ..
          fi

          if [ -d "ObsidianNeural-macOS-VST3" ]; then
            cd ObsidianNeural-macOS-VST3
            zip -r ../OBSIDIAN-Neural-macOS-VST3.zip .
            cd ..
          fi

          if [ -d "ObsidianNeural-Linux-VST3" ]; then
            cd ObsidianNeural-Linux-VST3
            tar -czf ../OBSIDIAN-Neural-Linux-VST3.tar.gz .
            cd ..
          fi

          # Copy Intel DMG and PKG
          if [ -f "ObsidianNeural-macOS-DMG-Intel/OBSIDIAN-Neural-Installer-macOS-Intel.dmg" ]; then
            cp "ObsidianNeural-macOS-DMG-Intel/OBSIDIAN-Neural-Installer-macOS-Intel.dmg" ./
          fi

          if [ -f "ObsidianNeural-macOS-PKG-Intel/OBSIDIAN-Neural-Installer-macOS-Intel.pkg" ]; then
            cp "ObsidianNeural-macOS-PKG-Intel/OBSIDIAN-Neural-Installer-macOS-Intel.pkg" ./
          fi

          # Copy ARM DMG and PKG
          if [ -f "ObsidianNeural-macOS-DMG-ARM64/OBSIDIAN-Neural-Installer-macOS-ARM64.dmg" ]; then
            cp "ObsidianNeural-macOS-DMG-ARM64/OBSIDIAN-Neural-Installer-macOS-ARM64.dmg" ./
          fi

          if [ -f "ObsidianNeural-macOS-PKG-ARM64/OBSIDIAN-Neural-Installer-macOS-ARM64.pkg" ]; then
            cp "ObsidianNeural-macOS-PKG-ARM64/OBSIDIAN-Neural-Installer-macOS-ARM64.pkg" ./
          fi

          # Linux installer
          if [ -d "ObsidianNeural-Python-linux" ]; then
            cp ObsidianNeural-Python-linux/obsidian-installer-linux ./OBSIDIAN-Neural-Installer-Linux
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: "OBSIDIAN-Neural v${{ github.run_number }}"
          body: |
            ## ðŸŽµ OBSIDIAN-Neural Release v${{ github.run_number }}

            ## ðŸ“¥ Installation Guide

            ### ðŸŽ¯ Recommended: Cloud API (All Platforms)

            **Easiest setup - No GPU, Python, or technical knowledge required**

            #### Windows
            1. **Download** `OBSIDIAN-Neural-Windows-VST3.zip`
            2. **Extract** to `C:\Program Files\Common Files\VST3\`
            3. **Get your API key** at [obsidian-neural.com](https://obsidian-neural.com)
            4. **Load in your DAW** and enter API key in settings

            #### macOS
            1. **Download** `OBSIDIAN-Neural-macOS-VST3.zip` and extract it

            2. **Install the VST3** (requires admin password):
            ```bash
            sudo cp -r ~/Downloads/OBSIDIAN-Neural.vst3 /Library/Audio/Plug-Ins/VST3/
            sudo xattr -cr /Library/Audio/Plug-Ins/VST3/OBSIDIAN-Neural.vst3
            sudo chmod +x /Library/Audio/Plug-Ins/VST3/OBSIDIAN-Neural.vst3/Contents/MacOS/OBSIDIAN-Neural
            ```

            3. **Get your API key** at [obsidian-neural.com](https://obsidian-neural.com)
            4. **Load in your DAW** and enter API key in settings

            **âš ï¸ Note:** VST3 not code-signed yet - working on proper signing/notarization.

            #### Linux
            1. **Download** `OBSIDIAN-Neural-Linux-VST3.tar.gz`
            2. **Extract** to `~/.vst3/`:
            ```bash
            mkdir -p ~/.vst3
            tar -xzf OBSIDIAN-Neural-Linux-VST3.tar.gz -C ~/.vst3/
            ```
            3. **Get your API key** at [obsidian-neural.com](https://obsidian-neural.com)
            4. **Load in your DAW** and enter API key in settings

            ---

            ### ðŸ”§ Advanced: Self-Hosted Server

            **For unlimited generations, privacy, or offline use**

            **Requirements:**
            - NVIDIA GPU with CUDA support
            - Python 3.10+
            - ~10GB disk space for models

            **Setup:**

            1. **Install Python dependencies** (all platforms):
            ```bash
            pip install torch torchaudio transformers stable-audio-tools scipy numpy fastapi uvicorn pydantic
            ```

            2. **Get Stability AI model access:**
                - Create account at [huggingface.co](https://huggingface.co)
                - Accept license at [stable-audio-open-1.0](https://huggingface.co/stabilityai/stable-audio-open-1.0)

            3. **Download the server script:**
                - **Windows**: `OBSIDIAN-Neural-Installer.py`
                - **macOS Intel**: `OBSIDIAN-Neural-Installer-macOS-Intel.dmg`
                - **macOS ARM**: `OBSIDIAN-Neural-Installer-macOS-ARM64.dmg`
                - **Linux**: `OBSIDIAN-Neural-Installer-Linux`

            4. **Run the installer** to download models and setup the server:
                - **Windows**: `python OBSIDIAN-Neural-Installer.py`
                - **macOS**: Open the DMG and run `OBSIDIAN-Neural-Installer`
                - **Linux**: `chmod +x OBSIDIAN-Neural-Installer-Linux && ./OBSIDIAN-Neural-Installer-Linux`

            5. **Start the server:**
                - The installer will set up everything and start the server
                - Default URL: `http://localhost:8000`

            6. **Configure VST3:**
                - Open plugin in your DAW
                - Click âš™ï¸ settings button
                - Choose "Server/API" mode
                - Enter: `http://localhost:8000`
                - Leave API key empty
                - Click "Save & Continue"

            **Benefits:**
            - âœ… Unlimited generations (no credit cost)
            - âœ… Full privacy (everything runs locally)
            - âœ… Variable duration (up to 47 seconds)
            - âœ… Works offline (after initial setup)

            **Note:** First generation will be slower as models download (~8GB).

            ---

            ### ðŸ–¥ï¸ Python Tools Installation (Optional)

            **For GUI installer and server management**

            #### Windows
            - **Requirements:** Python 3.10+ from [python.org](https://python.org)
            - **Download:** `OBSIDIAN-Neural-Installer.py`
            - **Run:** `python OBSIDIAN-Neural-Installer.py`

            #### macOS
            - **Intel Macs:** Use `*-Intel.dmg` or `*-Intel.pkg`
            - **Apple Silicon:** Use `*-ARM64.dmg` or `*-ARM64.pkg`

            **DMG Installation:**
            1. Download and double-click the `.dmg`
            2. Run `OBSIDIAN-Neural-Installer`
            3. If blocked: Right-click â†’ **Open** â†’ **Open** again

            **PKG Installation (system-wide):**
            1. Download the `.pkg` file
            2. If blocked by Gatekeeper: `sudo spctl --master-disable`
            3. Install package
            4. Re-enable Gatekeeper: `sudo spctl --master-enable`
            5. Run `obsidian-neural` from terminal

            #### Linux
            - **Download:** `OBSIDIAN-Neural-Installer-Linux`
            - **Run:**
            ```bash
            chmod +x OBSIDIAN-Neural-Installer-Linux
            ./OBSIDIAN-Neural-Installer-Linux
            ```

            ---

            ### ðŸŽ›ï¸ Configuration Options

            **Cloud API Mode** (Default, Recommended)
            - Server URL: `https://ai-harmony.duckdns.org/obsidian`
            - API Key: Get from [obsidian-neural.com](https://obsidian-neural.com)
            - Perfect for: Beginners, live performance, no setup hassle

            **Self-Hosted Mode** (Advanced)
            - Server URL: `http://localhost:8000`
            - API Key: Leave empty
            - Perfect for: Privacy, unlimited use, offline work

            **Local Model Mode** (Experimental, Windows only)
            - No server needed
            - Download models from [innermost47/stable-audio-open-small-tflite](https://huggingface.co/innermost47/stable-audio-open-small-tflite)
            - Copy to `%APPDATA%\OBSIDIAN-Neural\stable-audio\`
            - âš ï¸ Limited: Fixed 10s duration, high RAM usage

            ---

            ### ðŸ“– Full Documentation

            - **Getting Started:** [obsidian-neural.com/documentation](https://obsidian-neural.com/documentation.html?page=getting-started)
            - **DAW Setup Guide:** [First Steps](https://obsidian-neural.com/documentation.html?page=first-step)
            - **Build from Source:** [INSTALLATION.md](https://github.com/innermost47/ai-dj/blob/main/INSTALLATION.md)
            - **Troubleshooting:** [GitHub Issues](https://github.com/innermost47/ai-dj/issues)

            ---

            ### ðŸ’¡ Quick Comparison

            | Setup Type | Difficulty | Cost | Privacy | Best For |
            |------------|-----------|------|---------|----------|
            | **Cloud API** | â­ Easy | â‚¬14.99+/month | Cloud | Everyone |
            | **Self-Hosted** | â­â­â­ Hard | Free (GPU needed) | Local | Advanced users |
            | **Local Model** | â­â­ Medium | Free | Local | Testing only |

          files: |
            OBSIDIAN-Neural-Installer-macOS-Intel.dmg
            OBSIDIAN-Neural-Installer-macOS-Intel.pkg
            OBSIDIAN-Neural-Installer-macOS-ARM64.dmg
            OBSIDIAN-Neural-Installer-macOS-ARM64.pkg
            OBSIDIAN-Neural-Installer-Linux
            OBSIDIAN-Neural-Installer.py
            OBSIDIAN-Neural-*-VST3.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
