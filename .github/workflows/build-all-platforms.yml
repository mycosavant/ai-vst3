name: Build VST - All Platforms

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1

      - name: Configure CMake
        working-directory: vst
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release

      - name: Build
        working-directory: vst
        run: cmake --build build --config Release

      - name: Upload Windows VST
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-Windows-VST3
          path: vst/build/ObsidianNeuralVST_artefacts/Release/VST3/

  build-macos-universal:
    name: Build macOS Universal (10.15+)
    runs-on: macos-13

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install cmake ninja

      - name: Configure CMake
        working-directory: vst
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="10.15"

      - name: Build
        working-directory: vst
        run: cmake --build build --config Release

      - name: Fix macOS permissions
        run: chmod +x vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3/Contents/MacOS/*

      - name: Import Code Signing Certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          echo $MACOS_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security import certificate.p12 -k build.keychain -P $MACOS_CERTIFICATE_PWD -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k actions build.keychain
          rm certificate.p12

      - name: Sign VST3
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          codesign --force --sign "Developer ID Application: anthony charretier ($APPLE_TEAM_ID)" \
            --timestamp \
            --options runtime \
            --deep \
            vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3

      - name: Verify signature
        run: |
          codesign --verify --verbose vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3

      - name: Create ZIP for notarization
        run: |
          cd vst/build/ObsidianNeuralVST_artefacts/Release/VST3
          ditto -c -k --keepParent OBSIDIAN-Neural.vst3 OBSIDIAN-Neural.zip
          mv OBSIDIAN-Neural.zip ../../../../../

      - name: Notarize VST3
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool submit OBSIDIAN-Neural.zip \
            --apple-id $APPLE_ID \
            --password $APPLE_APP_SPECIFIC_PASSWORD \
            --team-id $APPLE_TEAM_ID \
            --wait

      - name: Staple VST3
        run: |
          xcrun stapler staple vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3

      - name: Verify build
        run: |
          echo "=== Universal Build Info ==="
          echo "Architecture:"
          lipo -info vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3/Contents/MacOS/OBSIDIAN-Neural
          echo ""
          echo "Deployment target:"
          otool -l vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3/Contents/MacOS/OBSIDIAN-Neural | grep -A 5 LC_BUILD_VERSION
          echo ""
          echo "Code signature:"
          codesign -dv --verbose=4 vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3

      - name: Upload macOS VST
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-macOS-Universal-VST3
          path: vst/build/ObsidianNeuralVST_artefacts/Release/VST3/

  build-macos-test:
    name: Test Build - macOS ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    if: github.event_name == 'pull_request'

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Ventura"
            runner: macos-13
            deployment_target: "13.0"
          - name: "Sonoma"
            runner: macos-14
            deployment_target: "14.0"
          - name: "Sequoia"
            runner: macos-15
            deployment_target: "15.0"

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: brew install cmake ninja

      - name: Configure CMake
        working-directory: vst
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="${{ matrix.deployment_target }}"

      - name: Build
        working-directory: vst
        run: cmake --build build --config Release

      - name: Verify deployment target
        run: |
          echo "=== Build for ${{ matrix.name }} ==="
          otool -l vst/build/ObsidianNeuralVST_artefacts/Release/VST3/OBSIDIAN-Neural.vst3/Contents/MacOS/OBSIDIAN-Neural | grep -A 5 LC_BUILD_VERSION

  test-macos-universal:
    name: Test Universal Build on macOS ${{ matrix.name }}
    needs: build-macos-universal
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-13
            name: "13-Ventura"
          - runner: macos-14
            name: "14-Sonoma"
          - runner: macos-15
            name: "15-Sequoia"

    steps:
      - name: Download Universal VST
        uses: actions/download-artifact@v4
        with:
          name: ObsidianNeural-macOS-Universal-VST3
          path: ./vst

      - name: Test VST loading
        run: |
          echo "=== Testing Universal Build on macOS ${{ matrix.name }} ==="
          VST_PATH="./vst/OBSIDIAN-Neural.vst3"

          if [ -d "$VST_PATH" ]; then
            echo "‚úì VST found"
            
            echo ""
            echo "Architecture:"
            lipo -info "$VST_PATH/Contents/MacOS/OBSIDIAN-Neural"
            
            echo ""
            echo "Deployment target:"
            otool -l "$VST_PATH/Contents/MacOS/OBSIDIAN-Neural" | grep -A 5 LC_BUILD_VERSION
            
            echo ""
            echo "Dependencies (first 15):"
            otool -L "$VST_PATH/Contents/MacOS/OBSIDIAN-Neural" | head -15
            
            echo ""
            echo "Code signature:"
            codesign -dv --verbose=4 "$VST_PATH" 2>&1 || echo "Not signed (expected in test build)"
            
            echo ""
            echo "‚úÖ Universal build successfully loaded on macOS ${{ matrix.name }}"
          else
            echo "‚ùå VST not found"
            exit 1
          fi

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build \
            libasound2-dev libx11-dev libxext-dev libxrandr-dev libxcomposite-dev \
            libxinerama-dev libxcursor-dev libfreetype6-dev libfontconfig1-dev \
            libgtk-3-dev libwebkit2gtk-4.1-dev libcurl4-openssl-dev

      - name: Configure CMake
        working-directory: vst
        run: cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        working-directory: vst
        run: cmake --build build --config Release

      - name: Upload Linux VST
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-Linux-VST3
          path: vst/build/ObsidianNeuralVST_artefacts/Release/VST3/

  build-python-executables:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
          - os: macos-13
            name: macos-intel
          - os: macos-latest
            name: macos-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          pip install pillow pyinstaller psutil pystray GPUtil

      - name: Build executables
        shell: bash
        run: |
          pyinstaller --onefile --hidden-import=psutil --hidden-import=pystray --hidden-import=GPUtil --name obsidian-server-${{ matrix.name }} server_interface.py
          pyinstaller --onefile --hidden-import=psutil --hidden-import=pystray --hidden-import=GPUtil --name obsidian-installer-${{ matrix.name }} installer.py

      - name: Upload Python executables
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-Python-${{ matrix.name }}
          path: dist/

  build-macos-packages:
    needs: [build-python-executables]
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Download macOS Python executables
        uses: actions/download-artifact@v4
        with:
          name: ObsidianNeural-Python-macos-intel
          path: ./python-tools-intel/

      - name: Download macOS ARM Python executables
        uses: actions/download-artifact@v4
        with:
          name: ObsidianNeural-Python-macos-arm64
          path: ./python-tools-arm64/

      - name: Import Code Signing Certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          echo $MACOS_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security import certificate.p12 -k build.keychain -P $MACOS_CERTIFICATE_PWD -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k actions build.keychain
          rm certificate.p12

      - name: Sign Intel executables
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          codesign --force --sign "Developer ID Application: anthony charretier ($APPLE_TEAM_ID)" \
            --timestamp \
            --options runtime \
            python-tools-intel/obsidian-installer-macos-intel

          codesign --force --sign "Developer ID Application: anthony charretier ($APPLE_TEAM_ID)" \
            --timestamp \
            --options runtime \
            python-tools-intel/obsidian-server-macos-intel

      - name: Sign ARM executables
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          codesign --force --sign "Developer ID Application: anthony charretier ($APPLE_TEAM_ID)" \
            --timestamp \
            --options runtime \
            python-tools-arm64/obsidian-installer-macos-arm64

          codesign --force --sign "Developer ID Application: anthony charretier ($APPLE_TEAM_ID)" \
            --timestamp \
            --options runtime \
            python-tools-arm64/obsidian-server-macos-arm64

      - name: Create Intel DMG
        run: |
          mkdir -p dmg-staging-intel
          cp python-tools-intel/obsidian-installer-macos-intel dmg-staging-intel/OBSIDIAN-Neural-Installer
          chmod +x dmg-staging-intel/OBSIDIAN-Neural-Installer

          create-dmg \
            --volname "OBSIDIAN-Neural-Installer-Intel" \
            --window-pos 200 120 \
            --window-size 500 300 \
            --icon-size 100 \
            --icon "OBSIDIAN-Neural-Installer" 250 150 \
            --hide-extension "OBSIDIAN-Neural-Installer" \
            "OBSIDIAN-Neural-Installer-macOS-Intel.dmg" \
            "dmg-staging-intel/"

      - name: Sign Intel DMG
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          codesign --force --sign "Developer ID Application: anthony charretier ($APPLE_TEAM_ID)" \
            --timestamp \
            OBSIDIAN-Neural-Installer-macOS-Intel.dmg

      - name: Notarize Intel DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool submit OBSIDIAN-Neural-Installer-macOS-Intel.dmg \
            --apple-id $APPLE_ID \
            --password $APPLE_APP_SPECIFIC_PASSWORD \
            --team-id $APPLE_TEAM_ID \
            --wait

          xcrun stapler staple OBSIDIAN-Neural-Installer-macOS-Intel.dmg

      - name: Create ARM DMG
        run: |
          mkdir -p dmg-staging-arm64
          cp python-tools-arm64/obsidian-installer-macos-arm64 dmg-staging-arm64/OBSIDIAN-Neural-Installer
          chmod +x dmg-staging-arm64/OBSIDIAN-Neural-Installer

          create-dmg \
            --volname "OBSIDIAN-Neural-Installer-ARM64" \
            --window-pos 200 120 \
            --window-size 500 300 \
            --icon-size 100 \
            --icon "OBSIDIAN-Neural-Installer" 250 150 \
            --hide-extension "OBSIDIAN-Neural-Installer" \
            "OBSIDIAN-Neural-Installer-macOS-ARM64.dmg" \
            "dmg-staging-arm64/"

      - name: Sign ARM DMG
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          codesign --force --sign "Developer ID Application: anthony charretier ($APPLE_TEAM_ID)" \
            --timestamp \
            OBSIDIAN-Neural-Installer-macOS-ARM64.dmg

      - name: Notarize ARM DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool submit OBSIDIAN-Neural-Installer-macOS-ARM64.dmg \
            --apple-id $APPLE_ID \
            --password $APPLE_APP_SPECIFIC_PASSWORD \
            --team-id $APPLE_TEAM_ID \
            --wait

          xcrun stapler staple OBSIDIAN-Neural-Installer-macOS-ARM64.dmg

      - name: Upload DMGs
        uses: actions/upload-artifact@v4
        with:
          name: ObsidianNeural-macOS-DMGs
          path: |
            OBSIDIAN-Neural-Installer-macOS-Intel.dmg
            OBSIDIAN-Neural-Installer-macOS-ARM64.dmg

  commit-binaries:
    needs: [build-python-executables]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    concurrency:
      group: commit-binaries
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ObsidianNeural-Python-*
          merge-multiple: false

      - name: Organize binaries
        run: |
          rm -rf bin/*
          mkdir -p bin

          if [ -d "ObsidianNeural-Python-macos-intel" ]; then
            cp ObsidianNeural-Python-macos-intel/obsidian-server-macos-intel bin/OBSIDIAN-Neural-Server-macos-intel
          fi

          if [ -d "ObsidianNeural-Python-macos-arm64" ]; then
            cp ObsidianNeural-Python-macos-arm64/obsidian-server-macos-arm64 bin/OBSIDIAN-Neural-Server-macos-arm64
          fi

          if [ -d "ObsidianNeural-Python-linux" ]; then
            cp ObsidianNeural-Python-linux/obsidian-server-linux bin/OBSIDIAN-Neural-Server-linux
          fi

      - name: Commit binaries
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add bin/
          git commit -m "Update binaries [skip ci]" || exit 0

          git pull --rebase origin main
          git push

  create-release:
    needs:
      [
        build-windows,
        build-macos-universal,
        test-macos-universal,
        build-linux,
        build-python-executables,
        build-macos-packages,
        commit-binaries,
      ]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release assets
        run: |
          # Copy installer.py for Windows users
          cp installer.py ./OBSIDIAN-Neural-Installer.py

          # VST3 plugins
          if [ -d "ObsidianNeural-Windows-VST3" ]; then
            cd ObsidianNeural-Windows-VST3
            zip -r ../OBSIDIAN-Neural-Windows-VST3.zip .
            cd ..
          fi

          if [ -d "ObsidianNeural-macOS-Universal-VST3" ]; then
            cd ObsidianNeural-macOS-Universal-VST3
            zip -r ../OBSIDIAN-Neural-macOS-VST3.zip .
            cd ..
          fi

          if [ -d "ObsidianNeural-Linux-VST3" ]; then
            cd ObsidianNeural-Linux-VST3
            tar -czf ../OBSIDIAN-Neural-Linux-VST3.tar.gz .
            cd ..
          fi

          # DMGs
          if [ -d "ObsidianNeural-macOS-DMGs" ]; then
            cp ObsidianNeural-macOS-DMGs/*.dmg ./
          fi

          # Linux installer
          if [ -d "ObsidianNeural-Python-linux" ]; then
            cp ObsidianNeural-Python-linux/obsidian-installer-linux ./OBSIDIAN-Neural-Installer-Linux
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: "OBSIDIAN-Neural v${{ github.run_number }}"
          body: |
            # üéµ OBSIDIAN-Neural Release v${{ github.run_number }}

            ## üì• Installation

            ### üéØ **Cloud API** (Recommended - No GPU Required)

            #### **Windows**
            1. Download `OBSIDIAN-Neural-Windows-VST3.zip`
            2. Extract to `C:\Program Files\Common Files\VST3\`
            3. Get your API key at [obsidian-neural.com](https://obsidian-neural.com)
            4. Load in your DAW

            #### **macOS** (10.15 Catalina ‚Üí 15.0 Sequoia)
            1. Download and extract `OBSIDIAN-Neural-macOS-VST3.zip`
            2. Double-click `OBSIDIAN-Neural.vst3` to install
            3. Get your API key at [obsidian-neural.com](https://obsidian-neural.com)
            4. Load in your DAW

            #### **Linux**
            1. Download `OBSIDIAN-Neural-Linux-VST3.tar.gz`
            2. Extract to `~/.vst3/`
            3. Get your API key at [obsidian-neural.com](https://obsidian-neural.com)
            4. Load in your DAW

            ---

            ### üîß **Self-Hosted Server** (Advanced)

            **Requirements:** NVIDIA GPU with CUDA, Python 3.10+

            - **Windows**: Run `python OBSIDIAN-Neural-Installer.py`
            - **macOS Intel**: Install `OBSIDIAN-Neural-Installer-macOS-Intel.dmg`
            - **macOS ARM**: Install `OBSIDIAN-Neural-Installer-macOS-ARM64.dmg`
            - **Linux**: Run `./OBSIDIAN-Neural-Installer-Linux`

            ---

            ## ‚ú® What's New

            - ‚úÖ **macOS Code Signing**: All macOS builds are now properly signed and notarized
            - ‚úÖ **Universal Binary**: Single build supports both Intel and Apple Silicon
            - ‚úÖ **Compatible**: macOS 10.15 Catalina through 15.0 Sequoia

            ---

            ## üìö Resources

            - üìò [Getting Started](https://github.com/innermost47/ai-dj#readme)
            - üéì [Video Tutorial](https://www.youtube.com/watch?v=l4KMC5adxVA)
            - üí¨ [Discussions](https://github.com/innermost47/ai-dj/discussions)
            - üêõ [Issues](https://github.com/innermost47/ai-dj/issues)

            ---

            ‚≠ê Star the repo if you find OBSIDIAN-Neural useful!

            Questions? Email: b03caa1n5@mozmail.com

          files: |
            OBSIDIAN-Neural-Installer.py
            OBSIDIAN-Neural-Windows-VST3.zip
            OBSIDIAN-Neural-macOS-VST3.zip
            OBSIDIAN-Neural-Linux-VST3.tar.gz
            OBSIDIAN-Neural-Installer-macOS-Intel.dmg
            OBSIDIAN-Neural-Installer-macOS-ARM64.dmg
            OBSIDIAN-Neural-Installer-Linux
